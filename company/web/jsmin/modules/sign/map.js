var map=new BMap.Map("allmap");map.centerAndZoom(new BMap.Point(116.404,39.915),11);map.addControl(new BMap.NavigationControl());map.addControl(new BMap.ScaleControl());map.addControl(new BMap.OverviewMapControl());map.enableScrollWheelZoom();map.addControl(new BMap.MapTypeControl());map.setCurrentCity("北京");function addMarker(j,c,h,i,k,g,e,a){var l=new BMap.Icon(a,new BMap.Size(23,31));var d=new BMap.Marker(j,{icon:l});map.addOverlay(d);var f="<div class='qdTk relative'><div class='qdTk_cont'><div class='qdTk_img'><img src='"+h+"'><p><a href='"+e+"/space/cons/index/id/"+g+"' target='_blank'>"+c+"</a></p></div><div class='qdTk_addr'><a href='#' class='fl'><span class='fl'>在</span>"+i+"</a></div></div><p class='time mt10'><span class='fl'>"+k+"</span><span class='fr'>签到</span></p></div>";var b=new BMap.InfoWindow(f);d.addEventListener("click",function(){this.openInfoWindow(b);document.getElementById("imgDemo").onload=function(){b.redraw()}})}var mapPage=$("#map_page").val();var memberString=$("#member_string").val();YY.util.ajaxApi(yyBaseurl+"/sign/mobile/index/act/ajax",function(a){$.each(a.data,function(c,d){var b=new BMap.Point(d.precision,d.latitude);addMarker(b,d.name,d.avatar,d.address,d.addtime,d.member_id,d.baseurl,d.tubiao)})},"POST","json",{page:mapPage,string:memberString});$(".yy-mobileuser").live("mouseover",function(){var a=($(this).attr("data"));YY.util.ajaxApi(yyBaseurl+"/sign/mobile/index/act/ajax",function(b){$.each(b.data,function(d,e){var c=new BMap.Point(e.precision,e.latitude);addMarker(c,e.name,e.avatar,e.address,e.addtime,e.member_id,e.baseurl,e.tubiao)})},"POST","json",{page:mapPage,string:memberString,currentId:a});$(".yy-mobileuser").removeClass("qdico_blue").addClass("qdico_red");$(this).addClass("qdico_blue")});function openStylePnl(){document.getElementById("divStyle").style.display="block"}function selectStyle(a){mkrTool.open();var b=BMapLib.MarkerTool.SYS_ICONS[a];mkrTool.setIcon(b);document.getElementById("divStyle").style.display="none"}var myhtml=[];myhtml.push('<span style="font-size:12px">当前位置: </span><br/>');myhtml.push('<div id="address" name="address"></div><input type="hidden" name="jingdu" id="jingdu" ><input type="hidden" name="weidu" id="weidu"><input type="hidden" name="hidden_addr" id="hidden_addr">');myhtml.push('<input type="button" name="btn_sign" value="签到" onclick="signOK()">');var newhtml=[];newhtml.push('<table width="250px" style="line-height:30px;"><tr>');newhtml.push('<td width="65">当前位置：</td><td width="173"><p id="address" style="width:167px;font-size: 14px;"></p><input type="hidden" name="jingdu" id="jingdu" ><input type="hidden" name="weidu" id="weidu"><input type="hidden" name="hidden_addr" id="hidden_addr"></td></tr>');newhtml.push('<tr><td>&nbsp;</td><td><input type="button" name="btn_sign" value="签到" onclick="signOK()"></td></tr></table>');var infoWin=new BMap.InfoWindow(myhtml.join(""),{offset:new BMap.Size(0,-10)});var curMkr=null;var gc=new BMap.Geocoder();var mkrTool=new BMapLib.MarkerTool(map,{followText:"选定位置",autoClose:true});mkrTool.addEventListener("markend",function(a){var b=a.marker;b.openInfoWindow(infoWin);var c=b.point;gc.getLocation(c,function(d){var e=d.addressComponents;$("#address").html(e.province+e.city+e.district+e.street+e.streetNumber);$("#hidden_addr").val(e.province+e.city+e.district+e.street+e.streetNumber);$("#jingdu").val(c.lng);$("#weidu").val(c.lat)});b.enableDragging();b.addEventListener("dragend",function(d){var f=d.point;gc.getLocation(f,function(e){var g=e.addressComponents;$("#address").html(g.province+g.city+g.district+g.street+g.streetNumber);$("#hidden_addr").val(g.province+g.city+g.district+g.street+g.streetNumber);$("#jingdu").val(f.lng);$("#weidu").val(f.lat)})});curMkr=b});function signOK(){var a=$("#hidden_addr").val();var c=$("#jingdu").val();var b=$("#weidu").val();YY.util.ajaxApi(yyBaseurl+"/sign/mobile/ajaxsigned",function(e){if(e.rs){$.yy.rscallback("签到成功");window.location=yyBaseurl+"/sign/mobile/index"}else{$.yy.rscallback(e.error)}},"POST","json",{address:a,jingdu:c,weidu:b})};