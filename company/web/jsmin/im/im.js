window._isIE=(navigator.appName=="Microsoft Internet Explorer");if(window._isIE){if(navigator.userAgent.indexOf("Opera")>-1){window._isIE=null}if(navigator.userAgent.indexOf("Windows NT 6.0")>-1){window._isVista=true}else{window._isVista=false}}else{if(navigator.userAgent.indexOf("Gecko")==-1){window._isIE=null}}var im_$=function(a){return"string"==typeof a?document.getElementById(a):a};var add_listen=function(h,f,d){f=f.toLowerCase();var c,b,a;if(f.indexOf("on")==0){c=f;b=f.substr(2)}else{c="on"+f;b=f}if(c=="onmousewheel"||c=="mousewheel"||b=="ondommousescroll"||b=="dommousescroll"){c="onmousewheel";b="DOMMouseScroll";a="mousewheel"}try{h.addEventListener(b,d,true);if(a){h.addEventListener(a,d,true)}}catch(g){h.attachEvent(c,d);try{window.event.cancelBubble=true}catch(g){}}};function im_htmlspecialchars(a){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/"/g,"&quot;");a=a.replace(/'/g,"&#039;");return a}function im_getLocalTime(a){if(im_getNowTime(a)==im_getNowTime()){return im_getNowTime(a,1,1)}else{return im_getNowTime(a,1)}}function im_getNowTime(g,j,l){if(g){var a=new Date(parseInt(g)*1000)}else{var a=new Date()}var f=a.getFullYear();var e=a.getMonth()+1;var h=a.getDate();var c=a.getHours();var d=a.getMinutes();var k=a.getSeconds();var b="";if(!l){b+=f+"-";if(e<10){b+="0"}b+=e+"-";if(h<10){b+="0"}b+=h}if(j&&!l){b+=" "}if(j){if(c<10){b+="0"}b+=c+":";if(d<10){b+="0"}b+=d+":";if(k<10){b+="0"}b+=k}return(b)}function getByteLen(c){var a=0;for(var b=0;b<c.length;b++){if(c[b].match(/[^\x00-\xff]/ig)!=null){a+=3}else{a+=1}}return a}function im_inArray(d,e,b){if(typeof d=="string"||typeof d=="number"){var a=e.length;for(var c=0;c<a;c++){if(d===e[c]){if(b){return c}return true}}return false}}function subStringToArr(k,f){var c=0;var d=0;var h=im_uid+"_^uu$S_";var l=/[^\x00-\xff]/g;var g="";var b=k.replace(l,"***").length;var a="";for(var e=0;e<b;e++){g=k.charAt(e).toString();if(g.match(l)!=null){c+=3}else{c++}if(c>f){a+=h+"\r\n";d++;h=g;c=0;continue}h+=g}if(f>=c){a+=h+"\r\n";d++}return a}function im_obj2Str(f){switch(typeof(f)){case"object":var d=[];if(f instanceof Array){for(var e=0,b=f.length;e<b;e++){d.push(im_obj2Str(f[e]))}return"["+d.join(",")+"]"}else{if(f instanceof RegExp){return f.toString()}else{for(var c in f){d.push('"'+c+'":'+im_obj2Str(f[c]))}return"{"+d.join(",")+"}"}}case"function":return"function() {}";case"number":return f.toString();case"string":return'"'+f.replace(/(\\|\")/g,"\\$1").replace(/\n|\r|\t/g,function(g){return("\n"==g)?"\\n":("\r"==g)?"\\r":("\t"==g)?"\\t":""})+'"';case"boolean":return f.toString();default:return f.toString()}}function im_dump(h,f){if(f==2){return console.log(h)}var a=[];var e=0;var c=0;if(typeof(h)=="object"){for(var d in h){var b=0;a[c]='<div style="color:blue;font-size:18px;">'+c+" "+e+" "+d+":"+h[d]+"</div>";if(typeof(h[d])=="object"){for(var g in h[d]){c++;a[c]='<div style="color:red;font-size:14px;">'+c+" "+e+"["+b+"] "+d+"."+g+":"+h[d][g]+"</div>";b++}}c++;e++}}a=a.join("");if(f==1){alert(a)}else{document.write(a)}}function im_getFollowList(){var h=followsObj.id?followsObj.id.length:0;var k='<div><div class="imGroup">';var b=k+'<a href="javascript:void(0);" ele_role="group" position="0" onclick="im_openOrCloseDiv(this,\'userFollowList_often\')"><span class="imsjLeft fl"></span><span class="fl">最近联系人（'+onlineOftenNum+"/"+allOftenNum+'）</span></a></div><div id="userFollowList_often"  ele_role="list"  style="display:none;"> <ul class="imPeList">';var f=k+'<a href="javascript:void(0);" ele_role="group" position="0" onclick="im_openOrCloseDiv(this,\'userFollowList_online\')"><span class="imsjLeft fl"></span><span class="fl">在线成员（'+onlineUserNum+'）</span></a></div><div id="userFollowList_online"  ele_role="list"  style="display:none;"> <ul class="imPeList">';var l=k+'<a href="javascript:void(0);" ele_role="group" position="0" onclick="im_openOrCloseDiv(this,\'userFollowList_follow\')"><span class="imsjLeft fl"></span><span class="fl">未分组成员（'+followsObj.num[0]["onlinenum"]+"/"+followsObj.num[0]["num"]+'）</span></a></div><div id="userFollowList_follow"  ele_role="list"  style="display:none;"> <ul class="imPeList" >';var g=[];for(i=0;i<h;i++){var d=followsObj.id[i];g[d]='<div><div class="imGroup"><a href="javascript:void(0);" ele_role="group" position="0" onclick="im_openOrCloseDiv(this,\'userFollowList_'+d+'\')"><span class="imsjLeft fl"></span><span class="fl">'+followsObj.name[d]+"（"+(followsObj.num[d]?(followsObj.num[d]["onlinenum"]?followsObj.num[d]["onlinenum"]:0):0)+"/"+(followsObj.num[d]?(followsObj.num[d]["num"]?followsObj.num[d]["num"]:0):0)+'）</span></a></div><div id="userFollowList_'+d+'" ele_role="list" style="display:none;"> <ul class="imPeList">'}minUserBoxOnline=minUserBoxOffline="";for(var j in allUsersObj){if(j==im_uid){continue}imZtOnline=(allUsersObj[j]["online"]==1)?"imZtOnline imOnlineSpan_"+j:"imZtOffline imOnlineSpan_"+j;useravatar=(allUsersObj[j]["avatar"]!="")?(pic_url+allUsersObj[j]["avatar"]+".thumb.jpg"):pic_url+"default_avatar.thumb.jpg";if(allUsersObj[j]["online"]==1){minUserBoxOnline+='<li rel="'+site_url+"api/ajax/partnerinfo/pid/"+j+'" tips="1" onclick="im_sendMSG(\''+allUsersObj[j]["id"]+'\',0)"><div class="imUserBox"><img title="'+allUsersObj[j]["name"]+'" src="'+useravatar+'"  onerror="this.src=\''+pic_url+'default_avatar.thumb.jpg\'" style="width:30px;height:30px;"><span class="imZtOnline ztLocation imOnlineSpan_'+j+'"></span></div></li>'}else{minUserBoxOffline+='<li rel="'+site_url+"api/ajax/partnerinfo/pid/"+j+'" tips="1" onclick="im_sendMSG(\''+allUsersObj[j]["id"]+'\',0)"><div class="imUserBox"><img title="'+allUsersObj[j]["name"]+'" src="'+useravatar+'"  onerror="this.src=\''+pic_url+'default_avatar.thumb.jpg\'" style="width:30px;height:30px;"><span class="imZtOffline ztLocation"></span></div></li>'}if(allUsersObj[j]["online"]==1){f+='<li rel="'+site_url+"api/ajax/partnerinfo/pid/"+j+'" tips="1" onclick="im_sendMSG(\''+allUsersObj[j]["id"]+'\',0)"><div class="imUserBox fl"><img src="'+useravatar+'"  onerror="this.src=\''+pic_url+'default_avatar.thumb.jpg\'" style="width:30px;height:30px;"><span class="'+imZtOnline+' ztLocation"></span></div><div class="imUserName fl">'+allUsersObj[j]["name"]+"</div></li>"}if(allUsersObj[j]["often"]==1){b+='<li rel="'+site_url+"api/ajax/partnerinfo/pid/"+j+'" tips="1" onclick="im_sendMSG(\''+allUsersObj[j]["id"]+'\',0)"><div class="imUserBox fl"><img src="'+useravatar+'"  onerror="this.src=\''+pic_url+'default_avatar.thumb.jpg\'" style="width:30px;height:30px;"><span class="'+imZtOnline+' ztLocation"></span></div><div class="imUserName fl">'+allUsersObj[j]["name"]+"</div></li>"}if(allUsersObj[j]["fid"]>0){if(g[allUsersObj[j]["fid"]]){g[allUsersObj[j]["fid"]]+='<li rel="'+site_url+"api/ajax/partnerinfo/pid/"+j+'" tips="1" onclick="im_sendMSG(\''+allUsersObj[j]["id"]+'\',0)"><div class="imUserBox fl"><img src="'+useravatar+'"  onerror="this.src=\''+pic_url+'default_avatar.thumb.jpg\'" style="width:30px;height:30px;"><span class="'+imZtOnline+' ztLocation"></span></div><div class="imUserName fl">'+allUsersObj[j]["name"]+"</div></li>"}}else{l+='<li rel="'+site_url+"api/ajax/partnerinfo/pid/"+j+'" tips="1" onclick="im_sendMSG(\''+allUsersObj[j]["id"]+'\',0)"><div class="imUserBox fl"><img src="'+useravatar+'"  onerror="this.src=\''+pic_url+'default_avatar.thumb.jpg\'" style="width:30px;height:30px;"><span class="'+imZtOnline+' ztLocation"></span></div><div class="imUserName fl">'+allUsersObj[j]["name"]+"</div></li>"}}b+="</ul></div></div>";f+="</ul></div></div>";l+="</ul></div></div>";allUserStr=b+f+l;for(i=0;i<h;i++){var d=followsObj.id[i];allUserStr+=g[d]+"</ul></div></div>"}e=minOurUserStr="";if(ourUserObj){allOurUsers=onOurUsers=0;for(var j in ourUserObj){if(!allUsersObj[j]){allUsersObj[j]=ourUserObj[j]}imZtOnline=(ourUserObj[j]["online"]==1)?"imZtOnline imOnlineSpan_"+j:"imZtOffline imOnlineSpan_"+j;if(ourUserObj[j]["online"]){onOurUsers++}allOurUsers++;e+='<li rel="'+site_url+"api/ajax/customercard/uid/"+j+'" tips="1" onclick="im_sendMSG(\''+ourUserObj[j]["id"]+'\',0)"><div class="imUserBox fl"><img src="'+site_url+'images/im/kefu.gif" style="width:30px;height:30px;"><span class="'+imZtOnline+' ztLocation"></span></div><div class="imUserName fl">空间客服</div></li>';minOurUserStr+='<li rel="'+site_url+"api/ajax/customercard/uid/"+j+'" tips="1" onclick="im_sendMSG(\''+ourUserObj[j]["id"]+'\',0)"><div class="imUserBox"><img title="空间客服" src="'+site_url+'images/im/kefu.gif" style="width:30px;height:30px;"><span class="'+imZtOnline+' ztLocation"></span></div></li>'}var e=k+'<a href="javascript:void(0);" ele_role="group" position="0" onclick="im_openOrCloseDiv(this,\'userFollowList_ouruser\')"><span class="imsjLeft fl"></span><span class="fl">空间客服（'+onOurUsers+"/"+allOurUsers+'）</span></a></div><div id="userFollowList_ouruser" style="display:none;"> <ul class="imPeList user_card">'+e+"</ul></div></div>"}allUserStr=(e=="")?allUserStr:(e+allUserStr);var c=document.createElement("div");c.innerHTML=allUserStr;c.className="list_ul user_card";c.style.position="relative";c.style.top="0px";im_$("im_userInitListBox").appendChild(c);minUserBoxStr='<ul class="list_ul user_card" style="position: relative; top: 0px;">'+minOurUserStr+minUserBoxOnline+minUserBoxOffline+'</ul><div class="chatScroll userScroll yy_im_scroll" style="position: absolute;top: 0;right: 0;"></div>';var a=document.createElement("div");a.id="im_list_div_min";a.style.height="445px";a.style.overflow="hidden";a.innerHTML=minUserBoxStr;im_$("im_minUserListBox").appendChild(a)}var newMsgNum=[];var newMsgIds=[];var lastMsgUser=allMsgNum=0;function im_sendMSG(b,a){if(!allUsersObj[b]){$.post(im_url+"ajax.php?act=getuserinfo",{fid:b},function(c){if(c!=-1){allUsersObj[b]=c;im_sendMSGMain(b,a);return}},"JSON")}else{im_sendMSGMain(b,a)}}function im_creatChat(d,c){var b=im_$("im_to_talk_"+d);if(!b){var b=document.createElement("div");b.id="im_to_talk_"+d;b.innerHTML='<div class="imRecord"><a href="javascript:void(0);" onclick="im_getAgoMSG(this,'+d+')">查看更早的聊天记录</a></div><div class="chatList pr" id="list_div_'+d+'" style="height:200px;overflow:hidden;"><ul class="clearfix list_ul " id="user_now_logs_'+d+'"></ul><div class="chatScroll uListScroll yy_im_scroll" style="height:0px;position: absolute;top: 0;right: 0;"></div></div>';im_$("im_alluser_chatbox_"+im_uid).appendChild(b);add_listen($("#list_div_"+d)[0],"mousewheel",function(f){var l=arguments[0]||window.event;var q=l.wheelDelta?l.wheelDelta/120:(0-l.detail/3);var o="",k=$("#list_div_"+d).find(".list_ul"),p=k.position().top,j=$("#list_div_"+d).height(),m=k.height(),n=m+j/2,h=$("#list_div_"+d).parent().find(".yy_im_scroll"),r=h.height();if(q==1){o="up"}else{o="down"}p=p+(q*80);if(p<(j-n)){p=(j-n)}if(p>0){p=0}var g=(-p/(n-j))*(j-r);k.css("top",p);h.css("top",g);try{l.preventDefault()}catch(l){}return false})}b.style.display="block";imZtOnline=(allUsersObj[d]["online"]==1)?"imZtOnline imOnlineSpan_"+d:"imZtOffline imOnlineSpan_"+d;var a=im_$("im_leftwhichuser_"+d);if(!a){a=document.createElement("li");a.id="im_leftwhichuser_"+d;a.innerHTML='<a href="javascript:void(0);" class="fl" onclick="im_sendMSG(\''+d+"','"+c+'\')"><span class="imcLine '+imZtOnline+'"></span><span class="fl imLname">'+allUsersObj[d]["name"]+'</span></a><a href="javascript:void(0);" class="fr imClose" onclick="im_delChatUser('+d+')"></a>';im_$("im_chatboxleftusers").appendChild(a)}return a}function im_sendMSGMain(e,a){if(e==im_uid){return false}im_$("msgcontent_"+im_uid).value="";im_upNoReadMSG(e);im_showMsgChatDiv();$("#im_alluser_chatbox_"+im_uid).children("div").css("display","none");$("#im_chatboxleftusers").children(".imgroupCur").removeClass("imgroupCur");imZtOnline=(allUsersObj[e]["online"]==1)?"imZtOnline imOnlineSpan_"+e:"imZtOffline imOnlineSpan_"+e;obj_tochatusers=im_creatChat(e,a);obj_tochatusers.className="imgroupCur";var d=$(obj_tochatusers).index();im_whichUserSign(d);chatboxnum=$("#im_chatboxleftusers").children("li").length;if(chatboxnum>1){$("#im_chatboxleft").css("display","block");$("#im_chatboxright").addClass("fr chatRightBox")}else{$("#im_chatboxleft").css("display","none");$("#im_chatboxright").removeClass("fr chatRightBox")}$("#im_chating_user_img").next("span")[0].className=imZtOnline+" ztLocation";var c=$("#im_chating_user_name");c.html(allUsersObj[e]["name"]);c.parent("a").attr("href",site_url+"space/cons/index/id/"+e);c.parent("a").removeAttr("rnum");c.parent("a").attr("tips","1");if(ourUserObj[e]){c.parent("a").attr("rel",site_url+"api/ajax/customercard/uid/"+e);im_$("im_chating_user_img").src=site_url+"images/im/kefu.gif"}else{c.parent("a").attr("rel",site_url+"api/ajax/partnerinfo/pid/"+e);im_$("im_chating_user_img").src=(allUsersObj[e]["avatar"]!="")?(pic_url+allUsersObj[e]["avatar"]+".thumb.jpg"):pic_url+"default_avatar.thumb.jpg"}if(im_uid==e){return false}var b="";$.post(im_url+"ajax.php?act=initwin",{id:e},function(f){b=f;if(!WebPush.aollowDo){$("#imBox").children("div").css("display","none");$("#imBox").css("display","block");$("#im_imChatBox").css("display","block")}});im_sendMessage=function(){var g=im_$("msgcontent_"+im_uid);var f=g.value.replace(/(^\s+)|(\s+$)/g,"");f=f.substr(0,200);if(f){$.post(im_url+"ajax.php?act=sendmsg",{qzid:qz_id,fid:e,v:f,vc:b},function(k){if(k!=-1){thistime=im_getLocalTime(k.time);var j=document.createElement("li");j.className="fRight";j.innerHTML='<div class="imMesTime">我 '+thistime+'</div><div class="pr imDet imdrSide"><span></span><p class="ltDeltails">'+im_htmlspecialchars(f)+"</p></div>";im_$("user_now_logs_"+e).appendChild(j);g.value="";if(k.id>=mostIndex){mostIndex=k.id+1}if(k.fid){var h=new Object();h.u=im_uid;h.f=k.fid;h.id=k.id;h.vc=k.vc;h=im_obj2Str(h);im_server.send(h)}}else{var j=document.createElement("li");j.className="fRight";j.innerHTML='<div class="pr imDet imdrSide"><span></span><p class="ltDeltails">'+im_htmlspecialchars(f)+"</p></div>发送失败";im_$("user_now_logs_"+e).appendChild(j)}im_updateSocll(e)},"JSON")}else{alert("请输入发送给"+allUsersObj[e]["name"]+"的内容");g.value=""}g.focus()};im_$("msgcontent_"+im_uid).onkeydown=function(f){var g=(f)?f:((window.event)?window.event:"");var h=g.keyCode?g.keyCode:g.which;if((g.keyCode==13&&g.ctrlKey)||(g.keyCode==13&&!g.ctrlKey)){im_sendMessage()}};im_$("msgcontent_"+im_uid).onkeyup=function(){var g=im_$("msgcontent_"+im_uid);if(g.value.length>=200){var f=g.value.replace(/(^\s+)|(\s+$)/g,"");g.value=f.substr(0,200)}};lastMsgUser=e;if(newMsgNum[lastMsgUser]){im_upMsgNum(newMsgNum[lastMsgUser],1);newMsgNum[lastMsgUser]=0}im_$("sendmessage_"+im_uid).onclick=im_sendMessage;im_$("msgcontent_"+im_uid).focus()}function im_noReadMSG(){var c="";if(newMsgIds.length>0){for(var a in newMsgIds){c+=newMsgIds[a]+","}c=c.replace(/(^,+)|(,+$)/g,"")}$.post(im_url+"ajax.php?act=noreadmsg",{ids:c},function(d){if(d!=-1){for(var b in d){im_openNewMSG(d[b])}}},"JSON")}function im_upNoReadMSG(a){newMsgIds[a]=newMsgIds[a]?newMsgIds[a]:"";if(newMsgIds[a]==""){return false}$.post(im_url+"ajax.php?act=upnoreadmsg",{ids:newMsgIds[a],fid:a},function(b){if(b!=-1){newMsgIds[a]=""}},"JSON")}function im_getMSG(a){var b=$.parseJSON(a);if(b.id&&b.f==im_uid){$.post(im_url+"ajax.php?act=getmsg",{id:b.id},function(c){if(c.id){im_openNewMSG(c)}},"JSON")}}function im_getAgoMSG(a,b){if(userMsgIndex[b]&&userMsgIndex[b]!=mostIndex){start=userMsgIndex[b];num=10}else{havenum=$("#user_now_logs_"+b).children("li").length;num=10+havenum;start=mostIndex}$.post(im_url+"ajax.php?act=getagomsg",{fid:b,start:start,num:num},function(f){if(f!=-1){if(num>10){$("#user_now_logs_"+b).html("")}for(var c in f){thistime=im_getLocalTime(f[c].sendtime);var e=document.createElement("li");if(f[c].uid==b){e.className="fLeft clear";thisname=allUsersObj[b]["name"];agomsgclass="imdlSide"}else{e.className="fRight";thisname="我";agomsgclass="imdrSide"}e.innerHTML='<div class="imMesTime">'+thisname+" "+thistime+'</div><div class="pr imDet '+agomsgclass+'"><span></span><p class="ltDeltails">'+f[c].msg+"</p></div>";$("#user_now_logs_"+b).prepend(e)}userMsgIndex[b]=f[c].id}else{a.innerHTML="没有更多的聊天记录了"}},"JSON")}function im_openNewMSG(a){if(!allUsersObj[a.uid]){$.post(im_url+"ajax.php?act=getuserinfo",{fid:a.uid},function(b){if(b!=-1){allUsersObj[a.uid]=b;im_showNewMSG(a);return}},"JSON")}else{im_showNewMSG(a)}}function im_showNewMSG(b){thistime=im_getLocalTime(b.sendtime);if(im_$("im_imChatBox").style.display=="none"){if(!im_$("user_now_logs_"+b.uid)){im_sendMSG(b.uid,0);im_$("im_imChatBox").style.display="none"}newMsgNum[b.uid]=newMsgNum[b.uid]?(newMsgNum[b.uid]+1):1;im_$("im_leftwhichuser_"+b.uid).className="imMoreClue";im_upMsgNum(1);im_showNewMsgDiv();newMsgIds[b.uid]=(newMsgIds[b.uid]=="")?b.id:(newMsgIds[b.uid]+","+b.id)}else{if(lastMsgUser!=b.uid){if(!im_$("user_now_logs_"+b.uid)){lastUser=lastMsgUser;im_sendMSG(b.uid,0);im_sendMSG(lastUser,0)}newMsgNum[b.uid]=newMsgNum[b.uid]?(newMsgNum[b.uid]+1):1;im_$("im_leftwhichuser_"+b.uid).className="imMoreClue";im_upMsgNum(1);newMsgIds[b.uid]=(newMsgIds[b.uid]=="")?b.id:(newMsgIds[b.uid]+","+b.id)}else{newMsgIds[b.uid]=(newMsgIds[b.uid]=="")?b.id:(newMsgIds[b.uid]+","+b.id);im_upNoReadMSG(b.uid)}}if(b.id>=mostIndex){mostIndex=b.id+1}var a=document.createElement("li");a.className="fLeft clear";a.innerHTML='<div class="imMesTime">'+allUsersObj[b.uid]["name"]+" "+thistime+'</div><div class="pr imDet imdlSide"><span></span><p class="ltDeltails">'+b.msg+"</p></div>";im_$("user_now_logs_"+b.uid).appendChild(a);im_updateSocll(b.uid)}function im_updateSocll(d){var b=$("#user_now_logs_"+d).height();var a=$("#user_now_logs_"+d).parent().height();var c=b-a<0?0:b-a;$("#user_now_logs_"+d).css("top",-c)}function im_readNewMsg(){im_showMsgChatDiv();im_sendMSG(lastMsgUser,0)}function im_upMsgNum(b,a){if(a){allMsgNum=allMsgNum-b}else{allMsgNum=allMsgNum+b}$("#im_newMsgNum").html(allMsgNum)}function im_showNewMsgDiv(){im_changeTitle();im_$("im_imChatBox").style.display="none";im_$("im_minChatUserDiv").style.display="none";im_$("im_newMsgSignDiv").style.display="block"}var im_step=0;var setTimeOutId="";function im_changeTitle(){if(allMsgNum>0){im_step++;if(im_step==3){im_step=1}if(im_step==1){document.title="［　　　　　］"}else{if(im_step==2){document.title="［您有新消息］"}}if(setTimeOutId){clearTimeout(setTimeOutId)}setTimeOutId=setTimeout("im_changeTitle()",500)}else{document.title=main_title}}function im_showMsgChatDiv(){im_changeTitle();im_$("im_minChatUserDiv").style.display="none";im_$("im_newMsgSignDiv").style.display="none";im_$("im_imChatBox").style.display="block"}function im_openMaxBox(a){$("#im_userInitListBox").find(".list_ul").css("top","0");if(window._isIE){window.event.cancelBubble=true}mindis=a?"none":"block";maxdis=a?"block":"none";im_$("minImListBox_"+im_uid).style.display=mindis;im_$("maxImListBox_"+im_uid).style.display=maxdis}function im_openOrCloseDiv(c,b){obj=im_$(b);if(obj.style.display=="none"){$("[ele_role=group]").children(".imsjBot").addClass("imsjLeft").removeClass("imsjBot");$("[ele_role=list]").hide();obj.style.display="block";var a=$(c).children(".imsjLeft");a.addClass("imsjBot");a.removeClass("imsjLeft");var e=$(c);if(e.attr("position")==0){var d=e.attr("data");if(!d||d=="of"){return}ulObj_window.load(d,1,function(f,g){if(f==-1){e.attr("position")=="nomore"}else{e.attr("position",parseInt(e.attr("position"))+pageSize_window);$(obj).find("ul").append(g)}},0)}}else{obj.style.display="none";var a=$(c).children(".imsjBot");a.addClass("imsjLeft");a.removeClass("imsjBot")}}function im_delChatUser(a){chatboxnum=$("#im_chatboxleftusers").children("li").length;if(chatboxnum<2){im_closeChatAllUser();return}if(chatboxnum<3){$("#im_chatboxleft").css("display","none");$("#im_chatboxright").removeClass("fr chatRightBox")}else{$("#im_chatboxleft").css("display","block");$("#im_chatboxright").addClass("fr chatRightBox")}deldivclassname=$("#im_leftwhichuser_"+a).attr("class");$("#im_to_talk_"+a).remove();$("#im_leftwhichuser_"+a).remove();if(deldivclassname=="imgroupCur"){$("#im_chatboxleftusers").children("li:first").children("a")[0].onclick()}userMsgIndex[a]=mostIndex}function im_closeChatAllUser(){$("#im_imChatBox").css("display","none");$("#im_alluser_chatbox_"+im_uid).html("");$("#im_chatboxleftusers").html("");userMsgIndex=[];newMsgIds=[]}function im_minChatAllUser(a){if(!a){if(allMsgNum>0){im_showNewMsgDiv();return}$("#im_imChatBox").css("display","none");$("#im_minChatUserDiv").css("display","block");$("#im_minChatUserDiv").children("a").children(".mName").html($("#im_chating_user_name").html())}else{im_showMsgChatDiv()}}function im_whichUserSign(c){var b=$("#im_chatboxleftusers");var d=b.children("li").index();var a=Math.floor(c/9)*9;var e=Math.floor(d/9)*9;if(a>e){a=e}a=(a>0)?(a-1):0;if(a>0){b.children("li").css("display","none");b.children("li:gt("+a+")").css("display","block");var f=a+10;if(e>f){b.children("li:gt("+f+")").css("display","none")}}else{b.children("li:lt(10)").css("display","block")}}function im_userListMove(b){var a=$("#im_chatboxleftusers").children("li:visible:first").index();if(!b){dex=(Math.floor(a/9)*9)+9}else{if(a>8){dex=(Math.floor(a/9)*9)-9}else{dex=0}}im_whichUserSign(dex)}var isSearched=[];function im_findFriend(){var b=im_$("im_whichFriendName");var c=b.value.replace(/(^\s+)|(\s+$)/g,"");if(c!=""){htmlStr="";if(isBig&&!im_inArray(c,isSearched)){$.post(im_url+"ajax.php?act=searchfriend",{key:c},function(e){htmlStr=im_ajaxFriend(e,c);$("#im_searchedUserDiv").html(htmlStr);$("#im_searchedUserDiv").addClass("imAss");var d=isSearched.length;isSearched[d]=c},"JSON")}else{for(var a in allUsersObj){if(allUsersObj[a]["name"]&&allUsersObj[a]["name"].indexOf(c)!=-1&&a!=im_uid){useravatar=(allUsersObj[a]["avatar"]!="")?(pic_url+allUsersObj[a]["avatar"]+".thumb.jpg"):pic_url+"default_avatar.thumb.jpg";htmlStr+='<li><a href="javascript:void(0);" onclick="im_sendMSG(\''+allUsersObj[a]["id"]+'\',0)"><img title="'+allUsersObj[a]["name"]+'" src="'+useravatar+'"  onerror="this.src=\''+pic_url+'default_avatar.thumb.jpg\'" class="fl lxtx" style="width:30px;height:30px;"><span class="fl">'+allUsersObj[a]["name"]+"</span></a></li>"}}$("#im_searchedUserDiv").html(htmlStr);$("#im_searchedUserDiv").addClass("imAss")}}else{$("#im_searchedUserDiv").html("");$("#im_searchedUserDiv").removeClass("imAss")}return false}function im_ajaxFriend(f,g){var e="";var c=[];for(var b in recentlyList){if(!isNaN(b)&&recentlyList[b]["name"]&&recentlyList[b]["name"].indexOf(g)!=-1&&b!=im_uid){var d=c.length;c[d]=a;useravatar=(recentlyList[b]["avatar"]!="")?(pic_url+recentlyList[b]["avatar"]+".thumb.jpg"):pic_url+"default_avatar.thumb.jpg";e+='<li><a href="javascript:void(0);" onclick="im_sendMSG(\''+recentlyList[b]["id"]+'\',0)"><img title="'+recentlyList[b]["name"]+'" src="'+useravatar+'"  onerror="this.src=\''+pic_url+'default_avatar.thumb.jpg\'" class="fl lxtx" style="width:30px;height:30px;"><span class="fl">'+recentlyList[b]["name"]+"</span></a></li>"}}if(f!=-1){for(var a in f){if(im_inArray(b,c)){continue}if(!allUsersObj[a]){allUsersObj[a]=f[a]}useravatar=(f[a]["avatar"]!="")?(pic_url+f[a]["avatar"]+".thumb.jpg"):pic_url+"default_avatar.thumb.jpg";e+='<li><a href="javascript:void(0);" onclick="im_sendMSG(\''+f[a]["id"]+'\',0)"><img title="'+f[a]["name"]+'" src="'+useravatar+'"  onerror="this.src=\''+pic_url+'default_avatar.thumb.jpg\'" class="fl lxtx" style="width:30px;height:30px;"><span class="fl">'+f[a]["name"]+"</span></a></li>"}}return e}function im_getBigUserHtml(c,d){var b="";for(var a in c){if(!allUsersObj[a]){allUsersObj[a]=c[a]}imZtOnline=(c[a]["online"]==1)?"imZtOnline imOnlineSpan_"+a:"imZtOffline imOnlineSpan_"+a;useravatar=(c[a]["avatar"]!="")?(pic_url+c[a]["avatar"]+".thumb.jpg"):pic_url+"default_avatar.thumb.jpg";if(d==1){b+='<li rel="'+site_url+"api/ajax/partnerinfo/pid/"+a+'" tips="1" onclick="im_sendMSG(\''+c[a]["id"]+'\',0)"><div class="imUserBox fl"><img src="'+useravatar+'" onerror="this.src=\''+pic_url+'default_avatar.thumb.jpg\'" style="width:30px;height:30px;"><span class="'+imZtOnline+' ztLocation"></span></div><div class="imUserName fl">'+c[a]["name"]+"</div></li>"}else{b+='<li rel="'+site_url+"api/ajax/partnerinfo/pid/"+a+'" tips="1" onclick="im_sendMSG(\''+c[a]["id"]+'\',0)"><div class="imUserBox"><img title="'+c[a]["name"]+'" src="'+useravatar+'" onerror="this.src=\''+pic_url+'default_avatar.thumb.jpg\'" style="width:30px;height:30px;"><span class="'+imZtOnline+' ztLocation"></span></div></li>'}}return b}function im_getBigrecentlyStr(){var b='<div><div class="imGroup"><a href="javascript:void(0);" position="0" ele_role="group" onclick="im_openOrCloseDiv(this,\'userFollowList_of\')" data="of"><span class="imsjLeft fl"></span><span class="fl"> 最近联系人（'+recentlyList.onlinenum+"/"+recentlyList.allnum+'）</span></a></div><div id="userFollowList_of" ele_role="list" style="display:none;"> <ul class="imPeList">';for(var a in recentlyList){useravatar=(recentlyList[a]["avatar"]!="")?(pic_url+recentlyList[a]["avatar"]+".thumb.jpg"):pic_url+"default_avatar.thumb.jpg";imZtOnline=recentlyList.onlinearr[a]?"imZtOnline imOnlineSpan_"+a:"imZtOffline imOnlineSpan_"+a;if(!isNaN(a)){if(!allUsersObj[a]){allUsersObj[a]=recentlyList[a]}b+='<li rel="'+site_url+"api/ajax/partnerinfo/pid/"+a+'" tips="1" onclick="im_sendMSG(\''+recentlyList[a]["id"]+'\',0)"><div class="imUserBox fl"><img src="'+useravatar+'"  onerror="this.src=\''+pic_url+'default_avatar.thumb.jpg\'" style="width:30px;height:30px;"><span class="'+imZtOnline+' ztLocation"></span></div><div class="imUserName fl">'+recentlyList[a]["name"]+"</div></li>"}}b+="</ul></div></div>";return b}function im_updateUserStatus(){var c=lmtstr="";for(var a in recentlyList){if(!isNaN(a)&&recentlyList[a]["id"]){c+=lmtstr+recentlyList[a]["id"];lmtstr=","}}for(var b in ourUserObj){c+=lmtstr+ourUserObj[b]["id"];lmtstr=","}$.post(im_url+"ajax.php?act=getstatus",{rids:c},function(e){for(var d in allUsersObj){if(allUsersObj[d]["online"]=="1"&&!e[d]){allUsersObj[d]["online"]="0";$(".imOnlineSpan_"+d).attr("class","imZtOffline ztLocation imOnlineSpan_"+d)}else{if(allUsersObj[d]["online"]=="0"&&e[d]){allUsersObj[d]["online"]="1";$(".imOnlineSpan_"+d).attr("class","imZtOnline ztLocation imOnlineSpan_"+d)}}}},"JSON")}var userList=function(a){this.position=0;this.data=[];this.option=a;this.list=[];this.state=true};userList.prototype={load:function(e,f,b,a){var c=this,d=YY.util.url(this.option.url);YY.util.ajax({url:d,success:function(g){var j=g.data;var h=im_getBigUserHtml(j,f);c.render(h,f);c.state=true;b(g,h)},data:"gid="+e+"&position="+a+"&pagesize="+c.option.pageSize,type:"POST",dataType:"JSON"})},render:function(a,b){if(b==0){$("#im_list_div_min").find(".list_ul").append(a)}},bind:function(){var a=this;add_listen($("#im_list_div_min")[0],"mousewheel",function(b){var k=arguments[0]||window.event;var p=k.wheelDelta?k.wheelDelta/120:(0-k.detail/3);var n="",j=$("#im_list_div_min").find(".list_ul"),o=j.position().top,g=$("#im_list_div_min").height(),l=j.height(),m=l+g/2,f=$("#im_list_div_min").parent().find(".yy_im_scroll"),q=f.height();if(p==1){n="up"}else{n="down"}o=o+(p*80);if(o<(g-m)){o=(g-m)}if(o>0){o=0}var c=(-o/(m-g))*(g-q);j.css("top",o);f.css("top",c);var h=j.attr("data");if((l-g/2)/3*2>-o&&a.state&&h!="nomore"&&n=="down"){a.state=false;a.load("mi",0,function(d){if(d==-1){j.attr("data","nomore")}else{j.attr("position",parseInt(j.attr("position"))+a.option.pageSize)}},j.attr("position"))}try{k.preventDefault()}catch(k){}return false});add_listen($("#im_userInitListBox")[0],"mousewheel",function(b){var l=arguments[0]||window.event;var r=l.wheelDelta?l.wheelDelta/120:(0-l.detail/3);var o="",j=$("#im_userInitListBox").find(".list_ul"),q=j.position().top,g=$("#im_userInitListBox").height(),m=j.height(),n=m+g/2,f=$("#im_userInitListBox").parent().find(".yy_im_scroll"),s=f.height();if(r==1){o="up"}else{o="down"}q=q+(r*80);if(q<(g-n)){q=(g-n)}if(q>0){q=0}var c=(-q/(n-g))*(g-s);j.css("top",q);f.css("top",c);var p=$("#im_userInitListBox").find(".imsjBot").parent();var h=p.attr("position");if((m-g/2)/3*2>-q&&a.state&&h!="nomore"&&o=="down"){a.state=false;var k=p.attr("data");if(!k){return}a.load(k,1,function(d,e){if(d==-1){p.attr("position","nomore")}else{p.attr("position",parseInt(p.attr("position"))+a.option.pageSize);p.parent().parent().find("[ele_role=list]").find("ul").append(e)}},p.attr("position"))}try{l.preventDefault()}catch(l){}return false})}};var pageSize_window=20;var ulObj_window=new userList({url:"/im/ajax.php?act=getusers",pageSize:pageSize_window});function im_getBigFollowList(){var e=noFollowUserStr="";onlineUserStr='<div><div class="imGroup"><a href="javascript:void(0);" position="0" ele_role="group" onclick="im_openOrCloseDiv(this,\'userFollowList_on\')" data="on"><span class="imsjLeft fl"></span><span class="fl"> 在线成员（'+bigUserCount.onlinenum+'）</span></a></div><div id="userFollowList_on"  ele_role="list"  style="display:none;"> <ul class="imPeList"></ul></div></div>';for(var b in followsObj.name){if(b==0){noFollowUserStr='<div><div class="imGroup"><a href="javascript:void(0);" position="0" ele_role="group" onclick="im_openOrCloseDiv(this,\'userFollowList_'+b+'\')" data="'+b+'"><span class="imsjLeft fl"></span><span class="fl">'+followsObj.name[b]+"（"+(allCountNum[b]?(allCountNum[b]["onlinenum"]?allCountNum[b]["onlinenum"]:0):0)+"/"+(allCountNum[b]?(allCountNum[b]["allnum"]?allCountNum[b]["allnum"]:0):0)+'）</span></a></div><div id="userFollowList_'+b+'"  ele_role="list"  style="display:none;"> <ul class="imPeList"></ul></div></div>'}else{e+='<div><div class="imGroup"><a href="javascript:void(0);" position="0" ele_role="group" onclick="im_openOrCloseDiv(this,\'userFollowList_'+b+'\')" data="'+b+'"><span class="imsjLeft fl"></span><span class="fl">'+followsObj.name[b]+"（"+(allCountNum[b]?(allCountNum[b]["onlinenum"]?allCountNum[b]["onlinenum"]:0):0)+"/"+(allCountNum[b]?(allCountNum[b]["allnum"]?allCountNum[b]["allnum"]:0):0)+'）</span></a></div><div id="userFollowList_'+b+'"  ele_role="list"  style="display:none;"> <ul class="imPeList"></ul></div></div>'}}d=minOurUserStr="";if(ourUserObj){allOurUsers=onOurUsers=0;for(var a in ourUserObj){if(!allUsersObj[a]){allUsersObj[a]=ourUserObj[a]}imZtOnline=(ourUserObj[a]["online"]==1)?"imZtOnline imOnlineSpan_"+a:"imZtOffline imOnlineSpan_"+a;if(ourUserObj[a]["online"]){onOurUsers++}allOurUsers++;d+='<li rel="'+site_url+"api/ajax/customercard/uid/"+a+'" tips="1" onclick="im_sendMSG(\''+ourUserObj[a]["id"]+'\',0)"><div class="imUserBox fl"><img src="'+site_url+'images/im/kefu.gif" style="width:30px;height:30px;"><span class="'+imZtOnline+' ztLocation"></span></div><div class="imUserName fl">空间客服</div></li>';minOurUserStr+='<li rel="'+site_url+"api/ajax/customercard/uid/"+a+'" tips="1" onclick="im_sendMSG(\''+ourUserObj[a]["id"]+'\',0)"><div class="imUserBox"><img title="空间客服" src="'+site_url+'images/im/kefu.gif" style="width:30px;height:30px;"><span class="'+imZtOnline+' ztLocation"></span></div></li>'}var d='<div><div class="imGroup"><a href="javascript:void(0);" position="0" ele_role="group" onclick="im_openOrCloseDiv(this,\'userFollowList_ouruser\')"><span class="imsjLeft fl"></span><span class="fl">空间客服（'+onOurUsers+"/"+allOurUsers+'）</span></a></div><div id="userFollowList_ouruser" ele_role="list" style="display:none;"> <ul class="imPeList">'+d+"</ul></div></div>"}recentlyStr=im_getBigrecentlyStr();e=recentlyStr+onlineUserStr+noFollowUserStr+e;e=(d=="")?e:(d+e);var f=document.createElement("div");f.innerHTML=e;f.className="list_ul user_card";f.style.position="relative";f.style.top="0px";im_$("im_userInitListBox").appendChild(f);minUserBoxStr='<ul class="list_ul user_card" style="position: relative; top: 0px;" position="0">'+minOurUserStr+'</ul><div class="chatScroll userScroll yy_im_scroll" style="position: absolute;top: 0;right: 0;"></div>';var c=document.createElement("div");c.id="im_list_div_min";c.style.height="445px";c.style.overflow="hidden";c.innerHTML=minUserBoxStr;im_$("im_minUserListBox").appendChild(c);ulObj_window.load("mi",0,function(g){if(g==-1){$("#im_list_div_min").find(".list_ul").attr("data","nomore")}else{$("#im_list_div_min").find(".list_ul").attr("position",parseInt($("#im_list_div_min").find(".list_ul").attr("position"))+pageSize_window)}},0);ulObj_window.bind()}function im_initMSG(){var a='{"u":"'+im_uid+'","s":"'+sesscode+'","st":"'+im_socket_code+'","to":"1"}';im_server.send(a)}function im_showBox(){if(WebPush.aollowDo){$("#im_online_status").html('<img src="'+site_url+'images/im/imManage1.gif" />');$("#im_online_status").attr("title","在线");im_$("imBox").style.display="block";im_noReadMSG();setInterval("im_updateUserStatus()",30000)}}WebPush.aollowDo=true;WebPush.log=function(a){};var im_server=new WebPush("ws://"+im_socket_ip+":"+im_socket_port);function im_init(){var b=im_$("msgcontent_"+im_uid);var a="";function c(){if(b.value!="连接服务器中..."){}}im_server.bind("open",function(){im_initMSG();setTimeout("im_showBox()",2000)});im_server.bind("connection_disconnected",function(){});im_server.bind("close",function(){});im_server.bind("connection_failed",function(){if(WebPush.aollowDo){im_noReadMSG();$("#im_online_status").html("<span>连接中...</span>");$("#im_online_status").attr("title","连接中...")}});im_server.bind("message",function(d){if(WebPush.aollowDo){im_getMSG(d)}});if(isBig){im_getBigFollowList()}else{im_getFollowList()}}im_init();function im_sendToIm(b,a){if(b==im_uid){return false}a=a.substr(0,200);$.post(im_url+"ajax.php?act=initwin",{id:b},function(c){$.post(im_url+"ajax.php?act=sendmsg",{qzid:qz_id,fid:b,v:a,vc:c},function(e){if(e.fid){var d=new Object();d.u=im_uid;d.f=e.fid;d.id=e.id;d.vc=e.vc;d=im_obj2Str(d);im_server.send(d)}},"JSON")})}$(function(){if(isBig){}else{add_listen($("#im_list_div_min")[0],"mousewheel",function(a){var h=arguments[0]||window.event;var n=h.wheelDelta?h.wheelDelta/120:(0-h.detail/3);var l="",g=$("#im_list_div_min").find(".list_ul"),m=g.position().top,f=$("#im_list_div_min").height(),j=g.height(),k=j+f/2,c=$("#im_list_div_min").parent().find(".yy_im_scroll"),o=c.height();if(n==1){l="up"}else{l="down"}m=m+(n*80);if(m<(f-k)){m=(f-k)}if(m>0){m=0}var b=(-m/(k-f))*(f-o);g.css("top",m);c.css("top",b);try{h.preventDefault()}catch(h){}return false});add_listen($("#im_userInitListBox")[0],"mousewheel",function(a){var h=arguments[0]||window.event;var n=h.wheelDelta?h.wheelDelta/120:(0-h.detail/3);var l="",g=$("#im_userInitListBox").find(".list_ul"),m=g.position().top,f=$("#im_userInitListBox").height(),j=g.height(),k=j+f/2,c=$("#im_userInitListBox").parent().find(".yy_im_scroll"),o=c.height();if(n==1){l="up"}else{l="down"}m=m+(n*80);if(m<(f-k)){m=(f-k)}if(m>0){m=0}var b=(-m/(k-f))*(f-o);g.css("top",m);c.css("top",b);try{h.preventDefault()}catch(h){}return false});$(".list_div").each(function(){var d=$(this).parent().find(".yy_im_scroll");var c=$(".list_ul"),b=$(this).height(),e=c.height();var a=b/((e+b/2)/b);d.height(a)})}});