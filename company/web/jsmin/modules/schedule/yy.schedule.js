var Schedule=function(j){var h=this;h.init=function(){var k=new Date(),m=k.getTime(),l=m+86400000;h.today=g(m);h.tomorrow=g(l);h.inviteUser=j.inviteUser;h.noticeUser=j.noticeUser;h.fileList=j.fileList};h.delScheduleUploadFile=function(k){$("#_file"+k).remove();fileids=$("#fids").val();if(fileids){fileids=fileids.split(",");leftfids=[];for(i=0;i<fileids.length;i++){if(fileids[i]!=k){leftfids.push(fileids[i])}}fileids=leftfids.join(",");$("#fids").val(fileids)}if($("#community_fids").length>0){fileids=$("#community_fids").val();if(fileids){fileids=fileids.split(",");leftfids=[];for(i=0;i<fileids.length;i++){if(fileids[i]!=k){leftfids.push(fileids[i])}}fileids=leftfids.join(",");$("#community_fids").val(fileids)}}};h.showButton=function(B){var u=new Date();var A=u.getTime();var F=$("#title"),m=$("#address"),z=$("#content"),y=$("#datepicker1"),l=$("#starthour"),k=$("#datepicker2"),r=$("#endhour"),x=$("#savesubmit");var n=true;if(z.length>0){h.txtCounter(z,2000)}h.txtCounter(F,200);h.txtCounter(m,200);var C=y.val().split("-");var o=$("#starthour").val();var p=o?(o+":00").split(":"):("00:00:00").split(":");var w=new Date(C[0],C[1]-1,C[2],p[0],p[1],p[2]);var q=w.getTime();var s=k.val().split("-");var D=$("#endhour").val();var E=D?($("#endhour").val()+":00").split(":"):("24:00:00").split(":");var v=new Date(s[0],s[1]-1,s[2],E[0],E[1],E[2]);var t=v.getTime();n=q<t?true:false;if(n){y.removeAttr("style");l.removeAttr("style");k.removeAttr("style");r.removeAttr("style")}else{if(B&&(B.is("#datepicker1")||B.is("#starthour"))){b(q);l.is(":disabled")&&l.val("");r.is(":disabled")&&r.val("")}else{$.yy.rscallback("时间错误，结束时间必须大于开始时间。",1);y.css("color","red");l.css("color","red");k.css("color","red");r.css("color","red")}}if(F.val()&&n){x.removeAttr("disabled").removeClass("grayButton").addClass("gzChengButton")}else{x.attr("disabled","disabled").removeClass("gzChengButton").addClass("grayButton")}z.yyautoWrap(2000)};h.filterByDate=function(m,k){var l=$(m),n=l.siblings('input[type="text"]').eq(0);if(!n.val()||!l.val()){return}if((k==="start"&&n.val()<l.val())||(k==="end"&&n.val()>l.val())){l.css("color","red");n.css("color","red");$(".rw_search_but").attr("disabled",true);return}l.removeAttr("style");n.removeAttr("style");$(".rw_search_but").attr("disabled",false)};h.ajaxGetData=function(){var n=$("#showType").val();var k=$("#sstatus").val();var p=$("#keywords").val();var m=$("#simportant").val();var l=$("#taskRole").val();var o=$("#datepicker3").val();var r=$("#datepicker4").val();var q="important="+m+"&showtype="+n+"&status="+k+"&keyword="+p+"&myrole="+l+"&startdate="+o+"&enddate="+r+"&rid="+Math.random();if(!$("#advsearch_box").hasClass("hidden")){if($("#relate_task").attr("checked")=="checked"){q+="&relate_task=1"}}YY.util.ajaxApi(url("/schedule/index/date/"),function(t){if(t.indexOf("gzCont")!=-1){$("#getcontent").html(t);$("#schedule_moreFeed").die("click");$("#schedule_moreFeed").live("click",getMoreClick);$("#schedule_moreFeed").html("查看更多>>");$("#footer_morefeed").show()}else{$("#getcontent").html("<div style='padding:20px;'>没有相关日程！</div>");$("#footer_morefeed").hide()}},"POST","html",q)};h.strLen=function(m){if(m==""||typeof m=="undefined"){return 0}var k=0;for(var l=0;l<m.length;l++){k+=m.charCodeAt(l)<0||m.charCodeAt(l)>255?2:1}return k};h.txtCounter=function(l,k){if(h.strLen(l.val())>k){l.val(h.getStrbylen(l.val(),k))}};h.getStrbylen=function(p,k){var l=0;var q=0;var o="";var n=p.split("");for(var m=0;m<n.length;m++){if(m<k&&l+h.byteLength(n[m])<=k){l+=h.byteLength(n[m]);q=m+1}}if(p.length>q){o=p.substr(0,q)}else{o=p}return o};h.byteLength=function(k){aMatch=k.match(/[^\x00-\x80]/g);return(k.length+(!aMatch?0:aMatch.length))};var f={};h.defaultText=function(){if($("#notice_p").val()==""){f.notice_p={txt:"添加参与人"}}if($("#contact_task").val()==""){f.contact_task={txt:"关联任务"}}if($("#title").val()==""){f.title={txt:"日程主题"}}if($("#content").val()==""){f.content={txt:"日程内容"}}if($("#address").val()==""){f.address={txt:"地点"}}if($("#notice_n").val()==""){f.notice_n={txt:"添加知会人"}}if($("#topic").val()==""){f.topic={txt:"话题"}}$.yy.defaultText(f)};h.getScheduleDefault=function(){return f};h.ajaxMiddleRequest=function(k){YY.util.ajaxApi(url("/schedule/index/date/"),function(l){if(l.indexOf("gzCont")!=-1){$("#getcontent").html(l);$("#schedule_moreFeed").die("click");$("#schedule_moreFeed").live("click",getMoreClick);$("#schedule_moreFeed").html("查看更多>>");$("#footer_morefeed").show()}else{$("#getcontent").html("<div style='padding:20px;'>没有相关日程！</div>");$("#footer_morefeed").hide()}},"POST","html",k)};h.scheduleMenuListClick=function(l){if(!$(l.target).hasClass("cur")){$(l.target).parent().find(".cur").removeClass("cur");$(l.target).addClass("cur")}var m={};if($(l.target).attr("role")!==""){m.showtype=$(l.target).attr("role")}else{m.showtype=0}if($(l.target).attr("data")!==""){m.myrole=$(l.target).attr("data")}else{m.myrole=0}if($("#schedule_relate_member_id").length>0){m.member_id=$("#schedule_relate_member_id").val()}h.ajaxMiddleRequest(m);var k=$("#li_status").find(".data");if(k.length>0){k.html("查看状态");k.attr("data",-1)}if($("#relate_task").length>0){$("#relate_task").attr("checked",false)}};h.statusClick=function(m){var n={};n.status=parseInt($(m.target).attr("data"))+1;var k=$("#scheduleMenuList").find(".cur");if(k.length>0){if(k.attr("role")!==""){n.showtype=k.attr("role")}else{n.showtype=0}if(k.attr("data")!==""){n.myrole=k.attr("data")}else{n.myrole=0}if($("#schedule_relate_member_id").length>0){n.member_id=$("#schedule_relate_member_id").val()}}var l=$("#li_status").find(".data");if(l.length>0){l.html($(m.target).attr("title"));l.attr("data",$(m.target).attr("data"))}if($("#relate_task").attr("checked")=="checked"){n.relate_task=1}h.ajaxMiddleRequest(n);$("#li_status").find(".tkBox").hide()};h.relateTaskClick=function(m){var n={};var k=$("#scheduleMenuList").find(".cur");if(k.length>0){if(k.attr("role")!==""){n.showtype=k.attr("role")}else{n.showtype=0}if(k.attr("data")!==""){n.myrole=k.attr("data")}else{n.myrole=0}}var l=$("#li_status").find(".data");if(l.length>0){n.status=parseInt(l.attr("data"))+1}else{n.status=0}if($(this).attr("checked")=="checked"){n.relate_task=1}h.ajaxMiddleRequest(n)};h.remindTypeShow=function(){if($("#schedule_remind_type").length>0){$("#schedule_remind_type").removeClass("hidden")}};h.remindTypeHide=function(){if($("#schedule_remind_type").length>0){$("#schedule_remind_type").addClass("hidden");var k=$("#schedule_remind_type").find('input[name="noticetype[]"]');if(k.length>0){k.each(function(n,o){$(o).attr("checked",false)})}var l=$("#schedule_remind_type").find('input[name="uppertime"]');if(l.length>0){l.val(15)}var m=$("#schedule_remind_type").find('select[name="unit_type"]');if(m.length>0){m.find('option[value="1"]').attr("selected",true)}}};h.listen=function(){$("#li_status").bind("mouseleave",function(){$(this).find(".tkBox").hide()}).bind("mouseenter",function(){$(this).find(".tkBox").show()});$("#li_status").find("a").bind("click",h.statusClick);$("#relate_task").bind("click",h.relateTaskClick);$("[name='imp']").live("click",function(){$("[name='important']").val($(this).attr("data"));$("[name='imp']").removeAttr("class");$(this).addClass("cur")});$(".rcTkHead a.calendar-tab").live("click",function(){var l=$(this);$(".rcTkHead a.calendar-tab").removeClass("cur");l.addClass("cur");$("#taskBox aside").hide();$(l.attr("rel")).show()});$("#title,#address,#addForm>#content").live({keyup:h.showButton,blur:h.showButton});var k=/^([01]?[\d]|2[0123]):[012345]?[\d]$/;$("#datepicker1").on({change:function(){var l=$(this);h.showButton(l)}});$("#starthour").on({change:function(){var m=$(this),n=$.trim(m.val()),l=k.test(n);if(!l){d()}h.showButton(m)}});$("#datepicker2").on({change:function(){var l=$(this),o=l.val();c();l.val(o);var n=$("#starthour"),m=$("#endhour");n.is(":disabled")&&(n.val(""),m.val(""));h.showButton(l)}});$("#endhour").on({change:function(){var l=$(this),m=$.trim(l.val());if(!k.test(m)){c()}h.showButton(l)}});$("#allday").bind({click:function(){if($(this).attr("checked")==="checked"){$("#datepicker1").val(h.today);$("#datepicker2").val(h.today);$("#starthour,#endhour").attr("disabled","disabled").val("");h.remindTypeHide()}else{d();$("#starthour").removeAttr("disabled");$("#endhour").removeAttr("disabled");h.remindTypeShow()}h.showButton()}});$("#sub-div a").bind("click",function(){if($("#schedule_detail").is(":hidden")){$("#schedule_detail").show();$(this).html("隐藏详情")}else{$("#schedule_detail").hide();$(this).html("填写详情")}});$("input[name='typeSelect']").live("click",function(){var m=$(this);var l=m.val();var n=["244px","27px","0px","0px","164px"];if(l==4){$(".jtbm").animate({left:n[l]},300,function(){$("#addNoticeUserBox").show();$("#type, #groupid,#type_id").val(0)})}else{$("span.jtbm").animate({left:n[l]},300,function(){$("#addNoticeUserBox").hide();$("#notice_list_n").find("li.rcAddmenListli").remove();$("#type").val(l);$("#type_id,#groupid").val(l==1?$("#aside_type_gid").find("span.icor").attr("data"):0)})}});$("#person a,#othertask a").live("mouseover",function(){var l=$(this);l.parent().parent().find("ul").hide();l.siblings().removeClass("cur fontB");l.addClass("cur fontB");l.live("click",function(){return false});$(l.attr("href")).show()});$("#person input").live("click",function(){$("#type").val("0");$("#groupid").val("0");$("menu.rcShareLi").find("input").attr("checked",false);$("#typeunpublic").attr("checked",true);$("#addNoticeUserBox").hide();$(".jtbm").animate({left:"164px"},300);$("#contact_task_yy_dl").html("");$("#yyauto_li_task").remove();var l='<li id="yyauto_li_task" class="clearfix rcAddmenListli"><span>'+$(this).parent().find("span").html()+'</span><input type="hidden" name="type_id" id="type_id" value="'+$(this).val()+'"/><a class="close" href="javascript:;"></a></li>';$("#contact_task_div").prepend(l).find(".close").bind("click",function(){$(this).parent().remove()});$.fancybox.close()});$("#advsearch").live("click",function(){var m=$(this);var l=m.html()=="高级搜索"?"关闭高级搜索":"高级搜索";if($("#showType").val()==1){$("#searchMember").show();$("#relate_task").parent().hide()}else{$("#searchMember").hide();$("#relate_task").parent().show()}m.html(l);$("#advsearch_box").toggleClass("hidden")});$("#taskMenuList").bind("click",function(){var l=$("#fydTk1");l.toggleClass("hidden");l.children("a").bind("click",function(){var m=$(this);var n=m.attr("data");if(n==$("#showType").val()){return}$("#showType").val(n);l.find(".icor").remove();$('<span class="icor"></span>').appendTo(m);$("#taskMenuList a.blueLink").html(m.text()+'<span class="xsj"></span>');if(n==1){$("#searchMember").show();$("#relate_task").parent().hide()}else{$("#searchMember").hide();$("#relate_task").parent().show()}$("li[role='"+n+"']").show();$("li[role='"+(1-n)+"']").hide();$("li[data='"+n*4+"']").trigger("click")})}).bind("mouseleave",function(){setTimeout(function(){$("#fydTk1").addClass("hidden")},1500)});if($("#scheduleMenuList").length>0){$("#scheduleMenuList").find("li").bind("click",h.scheduleMenuListClick)}};h.searchMemberAdd=function(n){var p="",s="",r="",k="";var l=$("#selectedContainter").find("figure");if(l.length<1){n.parent().prepend('<font color="red">请选择人员！</font>');return}for(var o=0;o<l.length;o++){var q=$(l[o]).attr("itemid");var m=$(l[o]).text().split("(");if($("#yyhidden_inp_"+q).length==0){p+='<input id="yyhidden_inp_'+q+'" type="hidden" class="friendid" value="'+q+'">';k=o!=(l.length-1)?",":"";s+=m[0]+k;r+=q+k}}$("#taskMemberListBox").find("input.friendid").remove();$("#keywords").val(r);$("#taskMemberListBox").append(p).find("span").html(s);$.fancybox.cancel();$.fancybox.close()};h.load=function(){$("#notice_p").yyautocomplete({defaultValue:h.inviteUser,appendTo:"#notice_div",selAppendTo:"#notice_list",ajaxUrl:yyBaseurl+"/common/search/ccnotice"});$("#notice_n").yyautocomplete({defaultValue:h.noticeUser,appendTo:"#notice_div_n",selAppendTo:"#notice_list_n",ajaxUrl:yyBaseurl+"/common/search/ccnotice"});if($("#fileContainer").length>0&&h.fileList.length>0){fileids=$("#fids").val();for(i=0;i<h.fileList.length;i++){str='<li id="_file'+h.fileList[i].id+'" class="clearfix"><span>'+h.fileList[i].title+'</span> <a onclick="s.delScheduleUploadFile('+h.fileList[i].id+');" class="fr" href="javascript:;">×</a></li>';$("#fileContainer").append(str).show();fileids=fileids?fileids+","+h.fileList[i].id:h.fileList[i].id}$("#fids").val(fileids);if($("#community_fids").length>0){$("#community_fids").val(fileids)}}$("#radio").buttonset();$("#datepicker1,#datepicker2").datepicker({prevText:"上月",nextText:"下月",dateFormat:"yy-mm-dd"});$("#datepicker3").datepicker({prevText:"上月",nextText:"下月",dateFormat:"yy-mm-dd",beforeShow:function(){$(this).addClass("z8")},onClose:function(){$(this).removeClass("z8");h.filterByDate(this,"start")}});$("#datepicker4").datepicker({prevText:"上月",nextText:"下月",dateFormat:"yy-mm-dd",beforeShow:function(){$(this).addClass("z8")},onClose:function(){$(this).removeClass("z8");h.filterByDate(this,"end")}});$.datepicker.setDefaults();$(".icoGlrw").fancybox();new $.yy.comboDiv({type_gid:{labelcss:"blueLink",defaultid:0,remote:yyBaseurl+"/api/info/mygroup/substr/18",format:function(l){var k=l.data,n=[];for(var m in k){n.push({title:k[m].group_name,txt:(k[m].labelTitle+(k[m].pub==1?"":'<span class="icoSuo"></span>')),id:k[m].gid})}return n},callback:function(k){if($("#typepublic").attr("checked")=="checked"){$("#type").val("1");$("#type_id,#groupid").val(k)}}}});$(".rcAddmenr").fancybox({onComplete:function(l){var m={};m=$(l).parent().parent().find(".rcAddmenListUl");var k=$(l).attr("for");$("#consoleBtn_"+k).bind("click",function(){if(k=="keywords"){h.searchMemberAdd($(this))}else{var p="";var n=$("#selectedContainter").find("figure");if(n.length<1){$("#msgNote").html("请选择人员!");return}for(var o=0;o<n.length;o++){var r=$(n[o]).attr("itemid");var q=$(n[o]).text().split("(");if($("#yyauto_li_"+r).length==0){p+='<li id="yyauto_li_'+r+'" class="clearfix rcAddmenListli"><span>'+q[0]+'</span><input type="hidden" value="'+r+'" name="'+k+'_value[]"><a class="close" href="javascript:;"></a></li>'}}$(m).prepend(p).find(".close").bind("click",function(){$(this).parent().remove()});$.fancybox.cancel();$.fancybox.close()}})}})};function e(k){k=k.toString();return k.length!==2?"0"+k:k}function g(n){var k=new Date(n),m=k.getFullYear(),o=k.getMonth()+1,l=k.getDate();o=e(o);l=e(l);return m+"-"+o+"-"+l}function d(){b()}function b(u){var x=u?new Date(u):new Date(),p=x.getHours(),o=x.getMinutes(),v=x.getTime(),q=v+86400000,n=g(v),w=g(q),s,k,t,m,r,l;s=n;t=e(p);r=e(o);if(o<30){k=n;m=t;l=o+30}else{if(p===23){k=w;m="00"}else{k=n;m=e(p+1)}l=e(o-30)}$("#datepicker1").val(s);$("#datepicker2").val(k);$("#starthour").val(t+":"+r);$("#endhour").val(m+":"+l)}function c(){var l=$("#datepicker1").val(),k=$("#starthour").val(),m=a(l,k);b(m)}function a(l,m){var l=l.split("-"),m=(m+":00").split(":"),k=new Date(l[0],l[1]-1,l[2],m[0],m[1],m[2]);return k.getTime()}};