(function(c,a,b){a=a||{};a.Avatar=function(m,k,i){var l=this,o;l.previewSelectors=[];var n=a.Avatar.prototype;if(typeof l.initUpload!=="function"){n.initUpload=function(){b.initUpload(function(){new InitUpload(k,q)})};n.initCrop=function(){b.loadScript(["/plugin/jquery.Jcrop.js"],{fn:function(){o=function(s){var r=this;r.goss=function(){c(i.avatarOrigin).Jcrop(m,function(){r.api=this})}}}})};n.upload_start=function(s){try{j.html('上传中，已上传 <span class="percent">0%</span>')}catch(r){}return true};n.upload_progress=function(s,v,u){try{var t=Math.ceil((v/u)*100);var w="";if(t===100){w="，正在处理，请稍候.."}j.find(".percent").html(t+"%"+w)}catch(r){this.debug(r)}};n.upload_success=function(u,s){try{s=c.parseJSON(s);if(typeof s.rs!=="undefined"&&s.rs){var v=c(".yy-button-line",p);v.css({visibility:"visible"});if(typeof e!=="undefined"&&typeof e.api!=="undefined"){e.api.destroy()}var r=s.data+"?"+Math.random();g.removeAttr("style").attr("src",r);c.each(l.previewSelectors,function(w,x){x.selector.attr("src",r)});g.on("load",function(){c(i.inputs_bigWidth).val(g.width());c(i.inputs_bigHeight).val(g.height());var y=s.data.split("qz")[1];y=y.substring(1);c(i.inputs_filepath).val(y);j.html("请选择合适区域");l.setOrigAvatar();var w=l.getOrigSelect();var x=true;m.allowMove=x;m.setSelect=w;e.goss();c(this).off("load")})}}catch(t){j.html("很抱歉，您的图片没有上传成功。")}};n.upload_error=function(){j.html("很抱歉，您的图片没有上传成功。")};n.setOrigAvatar=function(){var t=i.ref_width,r=i.ref_height,u=g.width(),s=g.height();f=1;g.css({visibility:"visible"});if(u>t||s>r){if(u<s){g.css({height:r});f=r/s}else{g.css({width:t});f=t/u}}};n.getOrigSelect=function(){var t=g.is(":hidden");t&&g.show();var D=i.ref_width,E=i.ref_height,s=g.width(),u=g.height(),z=s<u,v=z?s:u,w=v-10,C,r,B,A;if(z){C=5;B=(u-w)/2}else{C=(s-w)/2;B=5}r=C+w;A=B+w;t&&g.hide();return[C,B,r,A]};n.saveAvatar=function(r,s){if(!l.checkCoords()){return false}var t={sub:1,filepath:c(i.inputs_filepath).val(),mid:c(i.inputs_mid).val(),uid:c(i.inputs_uid).val(),bigwidth:c(i.inputs_bigWidth).val(),bigheight:c(i.inputs_bigHeight).val(),x:c(i.inputs_x).val(),y:c(i.inputs_y).val(),w:c(i.inputs_w).val(),h:c(i.inputs_h).val()};b.ajaxApi(r,function(u){if(u&&typeof u.rs!=="undefined"&&u.rs){typeof s==="function"&&s(u.data)}},"POST","json",t)};n.checkCoords=function(){if(c(i.inputs_x).val()==""){alert("请先上传图片然后选择裁切头像最后进行保存！");return false}return true};n.updateCoords=function(r){c("#x").val(r.x/f);c("#y").val(r.y/f);c("#w").val(r.w/f);c("#h").val(r.h/f)};n.showPreview=function(r){c.each(l.previewSelectors,function(s,t){l.setPreview(r,t.selector,t.selector_wrap,t.sizes)})};n.setPreview=function(C,E,x,F){var s=F;var t=s[0]/C.w,r=s[1]/C.h,D=t<r?t:r,z=c(i.inputs_bigWidth).val(),w=c(i.inputs_bigHeight).val(),v=z*f,y=w*f;D=D>1?1:D;var u=C.w/C.h,A,B;E.css({width:Math.round(D*v)+"px",height:Math.round(D*y)+"px",marginLeft:"-"+Math.round(D*C.x)+"px",marginTop:"-"+Math.round(D*C.y)+"px"});if(u>1){var A=D<1?s[0]:C.w,B=A/u;x.css({width:A,height:B,marginTop:(s[1]-B)/2,marginLeft:(s[0]-A)/2})}else{var B=D<1?s[1]:C.h,A=B*u;x.css({width:A,height:B,marginTop:(s[1]-B)/2,marginLeft:(s[0]-A)/2})}};n.setPreviewSelector=function(){var s=i.previews,r=0;c.each(s,function(t,u){l.previewSelectors[r]={selector:c(t),selector_wrap:c(t).parent(),sizes:u};r++})};n.bindEvents=function(){var r=c(".yy-cancel-avatar-upload",p);r.on({click:function(){window.location.href=window.location.href}});c("#sub").live("click",function(){var s=b.url("/common/avatar/sub");l.saveAvatar(s,function(t){c.yy.rscallback("头像保存成功！");window.location.href=window.location.href})});c("#subLogo").live("click",function(){var s=b.url("/setting/base/subthumb");l.saveAvatar(s,function(t){c.yy.rscallback("LOGO保存成功！");window.location.href=window.location.href})});c("#subSpaceLogo").live("click",function(){var s=b.url("/setting/dept/subthumb");l.saveAvatar(s,function(t){console.log(t);c("#avatarContainter").find("img").attr("src",t.src);c("#avatarContainter").find(".subSpaceLogo").val(t.path);c.yy.rscallback("LOGO保存成功！")})});c("#sublead").live("click",function(){var s=b.url("/common/avatar/sub");l.saveAvatar(s,function(t){c.yy.rscallback("头像保存成功！")})});c("#subLogolead").live("click",function(){var s=b.url("/setting/base/subthumb");l.saveAvatar(s,function(t){c.yy.rscallback("头像保存成功！")})})};n.crop_defaults={aspectRatio:0,minSize:[0,0],maxSize:[0,0],bgColor:"black",bgOpacity:0.6,allowSelect:false,onChange:l.showPreview,onSelect:l.updateCoords};n.upload_defaults={file_types:"*.jpg;*.jpeg;*.png;",file_size_limit:"5 MB",button_width:"111",button_height:"28",button_text_left_padding:"55",button_text:"",button_text_style:"",button_placeholder_id:"avatarUploadButton",upload_url:b.url("/common/avatar/upload"),upload_start_handler:l.upload_start,upload_progress_handler:l.upload_progress,upload_success_handler:l.upload_success,upload_error_handler:l.upload_error};n.ui_defaults={uploadBlock:"#avatarUploadBlock",processContainer:".yy-upload-process-container",avatarOrigin:"#avatarOrigin",inputs_filepath:"#filepath",inputs_mid:"#mid",inputs_uid:"#uid",inputs_bigWidth:"#bigwidth",inputs_bigHeight:"#bigheight",inputs_x:"#x",inputs_y:"#y",inputs_w:"#w",inputs_h:"#h",ref_width:288,ref_height:288,previews:{"#avatarMiddle":[150,150],"#avatarSmall":[48,48],"#avatarTiny":[30,30]}}}i=typeof i==="object"?i:{};i=c.extend({},l.ui_defaults,i);l.setPreviewSelector();m=typeof m==="object"?m:{};m=c.extend({},l.crop_defaults,m);l.initCrop();k=typeof k==="object"?k:{};k=c.extend({},l.upload_defaults,k);var q={uploadBlock:i.uploadBlock,processContainer:i.processContainer};var h=c(i.inputs_mid),d=c(i.inputs_uid);k.post_params={sessid:sessid,mid:h.val(),uid:d.val()};l.initUpload();var p=c(q.uploadBlock),j=c(q.processContainer,p),g=c(i.avatarOrigin),f=1,e=null;setTimeout(function(){if(typeof o!=="undefined"){e=new o(m)}else{l.initCrop();setTimeout(arguments.callee,100)}},100)}}(jQuery,YY,YY.util));